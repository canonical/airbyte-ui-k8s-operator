# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.
name: airbyte-ui
summary: Airbyte UI rock
description: Airbyte UI OCI image for the Airbyte UI charm
version: "1.4.0"
build-base: ubuntu@24.04
base: ubuntu@24.04
license: Apache-2.0
platforms:
  amd64:

services:
  nginx:
    override: replace
    summary: "NGINX service to serve Airbyte WebApp"
    command: "nginx -g 'daemon off;' -c /etc/nginx/nginx.conf"
    startup: enabled

environment:
  JAVA_HOME: /usr/lib/jvm/java-21-openjdk-amd64
  CDK_PYTHON: /usr/bin/python3.10
  CDK_ENTRYPOINT: /usr/lib/python3.10/dist-packages/airbyte_cdk/connector_builder/main.py
  CDK_VERSION: "5.12.0"

parts:
  config:
    plugin: dump
    source: files
    organize:
      nginx.conf: etc/nginx/nginx.conf
      default.conf: etc/nginx/conf.d/default.conf
      mime.types: etc/nginx/mime.types
    stage:
      - etc/nginx/nginx.conf
      - etc/nginx/conf.d/default.conf
      - etc/nginx/mime.types

  patches:
    plugin: dump
    source: ./patches
    organize:
      vite-config-http.patch: patches/vite-config-http.patch
    stage:
      - patches/vite-config-http.patch
    prime:
      - "-*"

  pull-airbyte-repo:
    after: [patches, config]
    plugin: dump
    source: https://github.com/airbytehq/airbyte-platform.git
    source-type: git
    source-tag: v1.4.0
    build-packages:
      - jq
      - curl
      - coreutils
      - bash
      - gradle
      - openjdk-21-jdk-headless
      - npm
      - libpq-dev
      - python3-dev
      - nginx
      - xxd
      - tzdata
      - gettext
      - gettext-base
    build-snaps:
      - docker
    stage-packages:
      - openjdk-21-jdk-headless
      - libpq-dev
      - gcc
      - libc6-dev
      - make
      - libssl-dev
      - libpcre2-dev
      - zlib1g-dev
      - linux-headers-generic
      - bash
      - findutils
      - gettext
      - gettext-base
      - python3-dev
      - jq
      - curl
      - tar
      - gzip
      - ca-certificates
      - libpcre3
      - libssl3
      - zlib1g
      - base-passwd
      - base-files
      - nginx
    override-build: |
      craftctl default

      git apply ${CRAFT_STAGE}/patches/*.patch

      ./gradlew :oss:airbyte-webapp:assemble --continue --max-workers 1
      ./gradlew --stop

      cp -r . ${CRAFT_PART_INSTALL}/airbyte-platform

      # mkdir -p ${CRAFT_PART_INSTALL}/etc/nginx/conf.d
      mkdir -p ${CRAFT_PART_INSTALL}/usr/share/nginx/html
      mkdir -p ${CRAFT_PART_INSTALL}/var/cache/nginx
      mkdir -p ${CRAFT_PART_INSTALL}/var/log/nginx

      cp -r ./airbyte-webapp/build/airbyte/docker/bin/build ${CRAFT_PART_INSTALL}/usr/share/nginx/html
      cp -r /usr/sbin/nginx ${CRAFT_PART_INSTALL}/sbin/nginx
    stage:
      - var/log/nginx
      - var/cache/nginx
      - usr/share/nginx/html
      - sbin/nginx
